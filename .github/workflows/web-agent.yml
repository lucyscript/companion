name: Web Agent (Playwright Alternative)

# This workflow provides an alternative agent implementation
# that uses web interfaces (ChatGPT, Claude, etc.) via Playwright
# when API access is limited or unavailable

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: string
      agent_type:
        description: 'Which web agent to use'
        required: true
        type: choice
        options:
          - chatgpt
          - claude
          - gemini
        default: 'chatgpt'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  web-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AGENT_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install
          npx playwright install chromium

      - name: Fetch issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }}
            });
            
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');

      - name: Run web agent
        env:
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          AGENT_TYPE: ${{ inputs.agent_type }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node .github/scripts/web-agent.js

      - name: Create working branch and commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="agent/${{ inputs.issue_number }}-$(echo '${{ steps.issue.outputs.title }}' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-50)"
          git checkout -b "$BRANCH_NAME"
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes generated"
            exit 0
          fi
          
          git add -A
          git commit -m "[Web Agent] ${{ steps.issue.outputs.title }} [automerge]

          Closes #${{ inputs.issue_number }}
          
          Generated by web agent (${{ inputs.agent_type }})"
          
          git push -u origin "$BRANCH_NAME"

      - name: Update issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: 'âœ… Web agent (${{ inputs.agent_type }}) completed work and created PR.'
            });
